---
- name: WSL AWS SSO authentication
  hosts: localhost
  connection: local
  gather_facts: yes

  tasks:
    - name: Check if AWS CLI is available
      command: aws --version
      register: aws_check
      failed_when: false
      changed_when: false

    - name: Fail if AWS CLI not installed
      fail:
        msg: "AWS CLI not found. Run wsl-setup.yml first."
      when: aws_check.rc != 0

    - name: Load AWS SSO configuration
      include_vars: config.yml

    - name: Check if AWS profile exists
      shell: aws configure list-profiles | grep -w "{{ aws_sso.profile_name }}"
      register: profile_exists
      failed_when: false
      changed_when: false

    - name: Display configuration instructions
      debug:
        msg: |
          Please run the following command manually to configure AWS SSO:
          aws configure sso --output={{ aws_sso.output_format }} --profile={{ aws_sso.profile_name }} --region={{ aws_sso.region }} --no-browser
          
          Use these values when prompted:
          SSO session name: {{ aws_sso.session_name }}
          SSO start URL: {{ aws_sso.start_url }}
          SSO region: {{ aws_sso.region }}
          CLI default client Region: {{ aws_sso.cli_region }}
          CLI default output format: {{ aws_sso.output_format }}
      when: profile_exists.rc != 0

    - name: Pause for manual configuration
      pause:
        prompt: "Press ENTER after completing the AWS SSO configuration above"
      when: profile_exists.rc != 0

    - name: AWS SSO login (existing profile)
      shell: aws sso login --profile {{ aws_sso.profile_name }}
      when: profile_exists.rc == 0

    - name: Set AWS profile in bashrc
      lineinfile:
        path: "{{ ansible_env.HOME }}/.bashrc"
        line: "export AWS_PROFILE={{ aws_sso.profile_name }}"
        create: yes

    - name: Set AWS profile in current session
      shell: export AWS_PROFILE={{ aws_sso.profile_name }}

    - name: Verify AWS authentication
      shell: aws sts get-caller-identity --profile {{ aws_sso.profile_name }}
      register: aws_identity
      ignore_errors: yes

    - name: Display authentication summary
      debug:
        msg: |
          WSL AWS SSO authentication completed!
          AWS Profile: {{ aws_sso.profile_name }}
          {% if aws_identity.rc == 0 %}
          Authentication: Successful
          {% else %}
          Authentication: Please complete SSO login manually
          {% endif %}