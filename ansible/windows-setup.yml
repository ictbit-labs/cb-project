---
- name: Windows local pre-deployment setup
  hosts: localhost
  connection: local
  gather_facts: yes
  vars:
    ansible_shell_type: powershell

  tasks:
    - name: Check Windows version
      fail:
        msg: "Windows 10/Server 2016 or higher required"
      when: ansible_os_family != "Windows" or ansible_distribution_major_version|int < 10

    - name: Install Chocolatey
      win_chocolatey:
        name: chocolatey
        state: present

    - name: Install system tools via Chocolatey
      win_chocolatey:
        name:
          - git
          - curl
          - wget
          - unzip
          - 7zip
        state: present

    - name: Check if AWS CLI is installed
      win_command: aws --version
      register: aws_cli_check
      failed_when: false
      changed_when: false

    - name: Install AWS CLI v2
      win_chocolatey:
        name: awscli
        state: present
      when: aws_cli_check.rc != 0

    - name: Check if Python is installed
      win_command: python --version
      register: python_check
      failed_when: false
      changed_when: false

    - name: Install Python
      win_chocolatey:
        name: python
        state: present
      when: python_check.rc != 0

    - name: Check if Node.js is installed
      win_command: node --version
      register: node_check
      failed_when: false
      changed_when: false

    - name: Install Node.js LTS
      win_chocolatey:
        name: nodejs-lts
        state: present
      when: node_check.rc != 0

    - name: Check if AWS CDK is installed
      win_command: cdk --version
      register: cdk_check
      failed_when: false
      changed_when: false

    - name: Install AWS CDK
      win_command: npm install -g aws-cdk
      when: cdk_check.rc != 0

    - name: Create Python virtual environment
      win_command: python -m venv C:\venv
      args:
        creates: C:\venv

    - name: Install requirements if file exists
      win_command: C:\venv\Scripts\pip.exe install -r requirements.txt
      args:
        chdir: "{{ ansible_env.PWD }}"
      ignore_errors: yes

    - name: Display installation summary
      debug:
        msg: "Windows software installation completed successfully!"